%% Load Datasets
close all; %clear;
tic
addpath('helper functions', 'source data',...
    'plotting functions','simulation and optimization', ...
    'source data')

PREFIX = '';
JHU_data = [PREFIX 'global covid cases jan19.xlsx'];
pop_file = [PREFIX 'global population data.xlsx'];
vacc_file = [PREFIX 'vaccinations jan19.xlsx'];
test_file = [PREFIX 'daily_tests data jan19.xlsx'];
variant_file = [PREFIX 'gisaid_variants jan19.xlsx'];
%% Color Scheme!
brown = [78 54 41]/255;
red   = [237 28 36]/255;
gold  = [255 199 44]/255;
black = [0 0 0];
gray  = [152, 164, 174]/255;
green = [101 166 102]/255;
pink = [237 197 218]/255;

fixed_params.brown=brown;fixed_params.red=red;fixed_params.gray=gray;
fixed_params.gold=gold;fixed_params.black=black;

fixed_params.optimize_params = 0;
%% Set Default Plot Settings
set(groot,'defaultAxesFontSize',35)
set(groot,'defaultLineLineWidth',8)
set(groot,'defaultFigurePosition',[2 0.2 1000 754])
set(groot,{'DefaultAxesXColor','DefaultAxesYColor','DefaultAxesZColor'},...
    {'k','k','k'})
set(groot,'defaultAxesFontName','Times New Roman')
set(groot,'defaultAxesColorOrder',[gold;pink;green;gray;brown;red]);
set(groot,'DefaultFigureVisible','on');
set(groot,'DefaultAxesLineStyleOrder',{'-','-.','--',':'})

% option to display figures or just save
set(groot,'DefaultFigureVisible','on')

%% Set Simulation Options
disp_opts.plot_cases = 0;
%------------------------------
disp_opts.sens_dV = 0;
disp_opts.sens_dI = 0; 
disp_opts.sens_dI_dV = 0;
%------------------------------
disp_opts.sens_alpha1 = 0; 
disp_opts.sens_alpha2 = 0;
disp_opts.sens_alpha_paired = 1; 
%------------------------------
disp_opts.stacked_bar = 0;
disp_opts.alpha_TS = 0;
%------------------------------
disp_opts.contour_alpha = 0; disp_opts.save_data_contour = 0;
%------------------------------
%------------------------------
disp_opts.legend = 0;
disp_opts.write_colormap = 0; 
%------------------------------
disp_opts.all_figs = 0;
disp_opts.save_figs = 0;
%% Creating figures for simulations
if disp_opts.plot_cases || disp_opts.all_figs
    disp_opts.plot_cases_fig = figure;
end
%------------------------------
if disp_opts.sens_dV || disp_opts.all_figs
    disp_opts.sens_dV_fig = figure;
    % Create textbox
    annotation(disp_opts.sens_dV_fig,'textbox',...
        [0.288711288711289 0.740308128113818 0.146853146853147 0.13223124042879],...
        'String',{'Increasing Sense of Safety'},...
        'LineWidth',0.5,...
        'LineStyle','none',...
        'Interpreter','latex',...
        'FontSize',30,...
        'FontName','Helvetica Neue',...
        'FitBoxToText','off');

    % Create arrow
    annotation(disp_opts.sens_dV_fig,'arrow',[0.331285697139356 0.327289693143352],...
        [0.179142385429923 0.656405785123644],'LineWidth',5,'HeadWidth',25,...
        'HeadLength',25);

    % Create textbox
    annotation(disp_opts.sens_dV_fig,'textbox',...
        [0.716283716283716 0.707503828483921 0.168831168831168 0.0709754977029144],...
        'String',{'(Medium'},...
        'LineWidth',0.5,...
        'LineStyle','none',...
        'Interpreter','latex',...
        'FontSize',40,...
        'FontName','Helvetica Neue',...
        'FitBoxToText','off');

    % Create textbox
    annotation(disp_opts.sens_dV_fig,'textbox',...
        [0.586413586413586 0.575803981623279 0.570429570429573 0.125574272588055],...
        'String',{'Sense of Safety)'},...
        'LineWidth',0.5,...
        'LineStyle','none',...
        'Interpreter','latex',...
        'FontSize',40,...
        'FontName','Helvetica Neue',...
        'FitBoxToText','off');

    % Create textbox
    annotation(disp_opts.sens_dV_fig,'textbox',...
        [0.731268731268731 0.598774885145483 0.131868131868131 0.0372848392036795],...
        'String',{'(High'},...
        'LineWidth',0.5,...
        'LineStyle','none',...
        'Interpreter','latex',...
        'FontSize',40,...
        'FontName','Helvetica Neue',...
        'FitBoxToText','off');

    % Create textbox
    annotation(disp_opts.sens_dV_fig,'textbox',...
        [0.587412587412587 0.428790199081169 0.294705294705295 0.13223124042879],...
        'String',{'Sense of Safety)'},...
        'LineWidth',0.5,...
        'LineStyle','none',...
        'Interpreter','latex',...
        'FontSize',40,...
        'FontName','Helvetica Neue',...
        'FitBoxToText','off');

    % Create textbox
    annotation(disp_opts.sens_dV_fig,'textbox',...
        [0.715284715284715 0.84226646248086 0.1008991008991 0.0842266462480857],...
        'String',{'(Low'},...
        'LineWidth',0.5,...
        'LineStyle','none',...
        'Interpreter','latex',...
        'FontSize',40,...
        'FontName','Helvetica Neue',...
        'FitBoxToText','off');

    % Create textbox
    annotation(disp_opts.sens_dV_fig,'textbox',...
        [0.586413586413586 0.721286370597245 0.570429570429573 0.125574272588055],...
        'String',{'Sense of Safety)'},...
        'LineWidth',0.5,...
        'LineStyle','none',...
        'Interpreter','latex',...
        'FontSize',40,...
        'FontName','Helvetica Neue',...
        'FitBoxToText','off');
    
    disp_opts.sens_dV_legend = legend;
    set(disp_opts.sens_dV_legend,...
        'Position',[0.531468531468531 0.515057951631419 0.225658457426689 0.442232180916445],...
        'Interpreter','latex',...
        'FontSize',40);
    legend boxoff
end

if disp_opts.sens_dI || disp_opts.all_figs
    disp_opts.sens_dI_fig = figure;
    figure1 = disp_opts.sens_dI_fig;
    
    % Create textbox
    annotation(figure1,'textbox',...
        [0.288711288711289 0.740308128113818 0.146853146853147 0.13223124042879],...
        'String',{'Increasing','Level of Caution'},...
        'LineWidth',0.5,...
        'LineStyle','none',...
        'Interpreter','latex',...
        'FontSize',30,...
        'FontName','Helvetica Neue',...
        'FitBoxToText','off');

    % Create arrow
    annotation(figure1,'arrow',[0.355675941041795 0.351679937045791],...
        [0.18642040580838 0.663683805502101],'LineWidth',5,'HeadWidth',25,...
        'HeadLength',25);

    % Create textbox
    annotation(figure1,'textbox',...
        [0.590122614512858 0.411322950172872 0.325994256363674 0.13223124042879],...
        'String','Level of Caution)',...
        'LineWidth',0.5,...
        'LineStyle','none',...
        'Interpreter','latex',...
        'FontSize',40,...
        'FontName','Helvetica Neue',...
        'FitBoxToText','off');

    % Create textbox
    annotation(figure1,'textbox',...
        [0.720704769485257 0.840810858405168 0.1008991008991 0.0842266462480857],...
        'String',{'(Low'},...
        'LineWidth',0.5,...
        'LineStyle','none',...
        'Interpreter','latex',...
        'FontSize',40,...
        'FontName','Helvetica Neue',...
        'FitBoxToText','off');

    % Create textbox
    annotation(figure1,'textbox',...
        [0.590930298247371 0.731475599127085 0.570429570429573 0.125574272588055],...
        'String','Level of Caution)',...
        'LineWidth',0.5,...
        'LineStyle','none',...
        'Interpreter','latex',...
        'FontSize',40,...
        'FontName','Helvetica Neue',...
        'FitBoxToText','off');

    % Create textbox
    annotation(figure1,'textbox',...
        [0.733447221252099 0.70604822440823 0.168831168831168 0.0709754977029143],...
        'String',{'(Medium'},...
        'LineWidth',0.5,...
        'LineStyle','none',...
        'Interpreter','latex',...
        'FontSize',40,...
        'FontName','Helvetica Neue',...
        'FitBoxToText','off');

    % Create textbox
    annotation(figure1,'textbox',...
        [0.590026955880614 0.572892773471896 0.570429570429573 0.125574272588055],...
        'String','Level of Caution)',...
        'LineWidth',0.5,...
        'LineStyle','none',...
        'Interpreter','latex',...
        'FontSize',40,...
        'FontName','Helvetica Neue',...
        'FitBoxToText','off');

    % Create textbox
    annotation(figure1,'textbox',...
        [0.734882100735759 0.591496864767027 0.131868131868131 0.0372848392036795],...
        'String',{'(High'},...
        'LineWidth',0.5,...
        'LineStyle','none',...
        'Interpreter','latex',...
        'FontSize',40,...
        'FontName','Helvetica Neue',...
        'FitBoxToText','off');
    
    disp_opts.sens_dI_legend = legend;
    set(disp_opts.sens_dI_legend,...
        'Position',[0.531468531468531 0.515057951631419 0.225658457426689 0.442232180916445],...
        'Interpreter','latex',...
        'FontSize',40);
    legend boxoff
end

if disp_opts.sens_dI_dV || disp_opts.all_figs
    disp_opts.sens_dI_dV_fig = figure;
    figure1 = disp_opts.sens_dI_dV_fig;
    
    disp_opts.sens_dI_dV_legend = legend;
    legend boxoff
    set(disp_opts.sens_dI_dV_legend,...
        'Interpreter','latex',...
        'FontSize',40);
end
%------------------------------
if disp_opts.sens_alpha1 || disp_opts.all_figs
    disp_opts.sens_alpha1_fig = figure;
    figure1 = disp_opts.sens_alpha1_fig;
    
    % Create textbox
    annotation(figure1,'textbox',...
        [0.230930086862291 0.46374335373245 0.208207047190098 0.13223124042879],...
        'String',{'Increasing','First Vaccination Rate'},...
        'LineWidth',0.5,...
        'LineStyle','none',...
        'Interpreter','latex',...
        'FontSize',30,...
        'FontName','Helvetica Neue',...
        'FitBoxToText','off');

    % Create arrow
    annotation(figure1,'arrow',[0.301746819316063 0.301232665639445],...
        [0.259200609592951 0.407569141193595],'LineWidth',5,'HeadWidth',25,...
        'HeadLength',25);
    
    disp_opts.sens_alpha1_legend = legend('Location','northeast');
    set(disp_opts.sens_alpha1_legend,...
        'Interpreter','latex',...
        'FontSize',40);
    legend boxoff
end

if disp_opts.sens_alpha2 || disp_opts.all_figs
    disp_opts.sens_alpha2_fig = figure;
    figure1 = disp_opts.sens_alpha2_fig;
    
    % Create arrow
    annotation(figure1,'arrow',[0.414414414414414 0.37037037037037],...
        [0.2882096069869 0.205240174672489],'LineWidth',5,'HeadWidth',25,...
        'HeadLength',25);

    % Create textbox
    annotation(figure1,'textbox',...
        [0.412111268043472 0.367673484736817 0.207508351576148 0.132231240428791],...
        'String',{'Increasing','Second Vaccination Rate'},...
        'LineWidth',0.5,...
        'LineStyle','none',...
        'Interpreter','latex',...
        'FontSize',30,...
        'FontName','Helvetica Neue',...
        'FitBoxToText','off');
    
    disp_opts.sens_alpha2_legend = legend('Location','northeast');
    set(disp_opts.sens_alpha2_legend,...
        'Interpreter','latex',...
        'FontSize',40);
    legend boxoff
end

if disp_opts.sens_alpha_paired || disp_opts.all_figs
    disp_opts.sens_alpha_paired_fig = figure;
    figure1 = disp_opts.sens_alpha_paired_fig;
    
    disp_opts.sens_alpha_paired_legend = legend;
    set(disp_opts.sens_alpha_paired_legend,'Interpreter','latex')
    legend boxoff
end
%------------------------------
if disp_opts.contour_alpha || disp_opts.all_figs
    disp_opts.contour_alpha_fig = figure;
end
%------------------------------
if disp_opts.legend || disp_opts.all_figs
    disp_opts.legend_fig = figure;
end
%% Set Populations
% india germany canada brazil japan US
loc_list.US = 'United States'; % title for legend
pop_names.US = "United States of America"; % name in UN population spreadsheet
JHU_names.US = "US"; % location name in JHU spreadsheet
var_names.US = "USA";
td_list.US = 8; % CHANGE BACK TO 8

loc_list.IN = 'India';
td_list.IN = 6;

loc_list.DE = 'Germany';
td_list.DE = 5;

loc_list.CA = 'Canada';
td_list.CA = 6;

loc_list.BR = 'Brazil';
td_list.BR = 5;

loc_list.KR = 'South Korea';
pop_names.KR = "Republic of Korea";
JHU_names.KR = ["Korea, South"];
td_list.KR = 7;

% fn = {'IN'};
fn = {'US'};
for k = 1:length(fn)

location = loc_list.(fn{k});
nturn_dates = td_list.(fn{k});

if isfield(pop_names,fn{k})
      pop_name = pop_names.(fn{k});
else; pop_name = loc_list.(fn{k});
end

if isfield(JHU_names,fn{k})
      JHU_name = JHU_names.(fn{k});
else; JHU_name = loc_list.(fn{k});
end

if isfield(var_names,fn{k})
      vsheet_name = var_names.(fn{k});
else; vsheet_name = loc_list.(fn{k});
end

fprintf(1, [loc_list.(fn{k}) '\n']);

% get data from source
[US_data,N] = set_population(JHU_data,pop_file,pop_name,JHU_name);
fixed_params.test_data = get_test_data(location, test_file);
fixed_params.vacc_data = get_vacc_data(location, vacc_file);
var_data.vsheet_name = vsheet_name; var_data.variant_file = variant_file;

%% Optimize Parameters and Run Simulation
% time frame used to fit parameters
start_day = 53;
end_day = length(US_data.cases);%358+46;

% length of simulation (days)
T = end_day - start_day;
t_span = [0 T];

% set fixed_param array for simulation
fixed_params.US_data = US_data; fixed_params.start_day = start_day; 
fixed_params.end_day = end_day; fixed_params.nturn_dates = nturn_dates;
fixed_params.N = N; fixed_params.location = location;
% vaccine characteristics
fixed_params.vacc_data = get_vacc_data(location, vacc_file);

fixed_params = set_sens_vars(fixed_params);

fixed_params = set_sens_plot_specs(fixed_params);

[param,fixed_params] = set_params(fixed_params, var_data);

disp_opts = generate_plots_predictions(param, fixed_params, disp_opts);
end
toc
set(0,'DefaultFigureVisible','on')